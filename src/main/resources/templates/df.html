<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="/header">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
</head>

<body>
<div id="wrapper">
    <nav th:include="nav.html"></nav>
    <h1 class="page-header">Digital Foundation</h1>
    <div id="main" style="width: 100%;height:650px;"></div>
    <input type="text" name="queryInput" id="queryInput" placeholder="搜索" style="width:250px" class="input-text">
    <!-- form -->
    <div class="row clearfix">
        <div class="col-md-12 column">
            <p><span>Source System Name: </span><input type="text" id="source"/>&nbsp;
                <span>Target System Name: </span><input type="text" id="target"/></p>
            <p><span>Scenario Name&nbsp;&nbsp;</span>
                <select id="scenario"></select>
            </p>
            &nbsp;<button type="button" class="btn btn-default btn-primary" onclick="search()">Search</button>
        </div>
    </div>

    <!-- table -->
    <div class="table-responsive">
        <table id="table" class="table table-striped">
            <thead>
            <tr>
                <th>Interface id</th>
                <th>Interface Name</th>
                <th>Source Interface</th>
                <th>Source Interface Type</th>
                <th>Source System</th>
                <th>Target Interface</th>
                <th>Target Interface Type</th>
                <th>Target System</th>
                <th>Integration Platform</th>
                <th>Scenario Name</th>
                <th>Remark</th>
            </tr>
            </thead>
        </table>
    </div>

</div>
<!-- /#wrapper -->
<script>
    document.title = 'Digital Fundation';

    $(function () {
        //初始化表格
        var table = $("#table").dataTable({
            //scrollX: 400,   //表格内滑动
            bLengthChange: false,
            processing: true,  //隐藏加载提示,自行处理
            serverSide: true,  //启用服务器端分页
            searching: false,  //禁用原生搜索
            orderMulti: true,  //启用多列排序
            ordering: true,//使用排序
            bStateSave: false,//记录cookie
            order: [],  //取消默认排序查询,否则复选框一列会出现小箭头
            pagingType: "simple_numbers",  //分页样式：simple,simple_numbers,full,full_numbers

            ajax: function (data, callback, settings) {
                //封装请求参数
                console.log(data);
                var param = {};
                param.pageSize = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
                param.startIndex = data.start;//开始的记录序号
                param.pageIndex = (data.start / data.length) + 1;//当前页码
                param.query = $("input[name='queryInput']").val();//获取查询信息
                console.log(data.order[0]);
                param.order = data.order[0];
                param.source = $("#source").val();
                param.target = $("#target").val();
                param.scenario = $("#scenario").val();

                console.log(param);
                //ajax请求数据
                $.ajax({
                    type: "GET",
                    url: "/portal/dfquery",
                    cache: false,  //禁用缓存
                    data: param,  //传入组装的参数
                    dataType: "json",
                    success: function (result) {
                        console.log(result);
                        //封装返回数据
                        var returnData = {};
                        returnData.draw = data.draw;//这里直接自行返回了draw计数器,应该由后台返回
                        returnData.recordsTotal = result.totalCount;//返回数据全部记录
                        returnData.recordsFiltered = result.totalCount;//后台不实现过滤功能，每次查询均视作全部结果
                        returnData.data = result.data;//返回的数据列表
                        //调用DataTables提供的callback方法，代表数据已封装完成并传回DataTables进行渲染
                        //此时的数据需确保正确无误，异常判断应在执行此回调前自行处理完毕
                        callback(returnData);
                    }
                });
            },
            //列表表头字段
            columns: [
                {"data": "interface_id"},
                {"data": "interface_name"},
                {"data": "source_interface"},
                {"data": "source_interface_type"},
                {"data": "source_system"},
                {"data": "target_interface"},
                {"data": "target_interface_type"},
                {"data": "target_system"},
                {"data": "integration_platform"},
                {"data": "scenario_name"},
                {"data": "remark"}
            ],
        }).api();//此处需调用api()方法,否则返回的是JQuery对象而不是DataTables的API对象

        // input refresh table
        $("#queryInput").on('input',function () {
            table.ajax.reload();
        });

    });
    //search button function
    function search() {
        $("#table").dataTable().fnDraw();
    }

    // 基于准备好的dom，初始化echarts实例
    function createMap() {
        $("#main").removeAttr("_echarts_instance_").empty();
        var myChart = echarts.init(document.getElementById('main'));
        myChart.showLoading();
        $.get('../data/demo.gexf', function (xml) {
            myChart.hideLoading();
            console.log("loading successful");
            var graph = echarts.dataTool.gexf.parse(xml);
            var categories = [];
            for (var i = 0; i < 5; i++) {
                categories[i] = {
                    name: 'Category ' + i
                };
            }
            graph.nodes.forEach(function (node) {
                node.itemStyle = null;
                node.value = node.symbolSize;
                node.symbolSize /= 1.5;
                node.label = {
                    show: node.symbolSize > 30
                };
                node.category = node.attributes.modularity_class;
            });
            myChart.on('click', function (node) {
                document.getElementById('queryInput').value = "system=" + node.name;
                $("#table").dataTable().fnDraw();
                // myChart.setOption(option, true);
                myChart.clear();
                createMap();
            });
            option = {
                tooltip: {},
                legend: [{
                    // selectedMode: 'single',
                    data: categories.map(function (a) {
                        return a.name;
                    })
                }],
                animationDuration: 1500,
                animationEasingUpdate: 'quinticInOut',
                series: [
                    {
                        name: '',
                        type: 'graph',
                        layout: 'none',
                        data: graph.nodes,
                        links: graph.links,
                        categories: categories,
                        roam: true,
                        focusNodeAdjacency: true,
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1,
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        },
                        label: {
                            position: 'right',
                            formatter: '{b}'
                        },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.3
                        },
                        emphasis: {
                            lineStyle: {
                                width: 10
                            }
                        }
                    }
                ]
            };
            myChart.setOption(option);
        }, 'xml');
    }
    $(function(){
        createMap();
    })

    $(document).ready(function(){
        $.ajax({
            contentType : "application/json;charset=utf-8",
            type : "POST",
            url : "queryScenario",
            dataType : "json",
            success : function(data) {
                $.each(data, function(i, scenario) {
                    $('#scenario').append(
                        $('<option>').text(scenario).attr('value',
                            scenario));
                });
            }
        });
    });
</script>

</body>
<footer th:include="/footer">
</footer>
</html>
